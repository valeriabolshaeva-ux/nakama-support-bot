---
description: Rules for backend Python/FastAPI development
globs: ["backend/**/*.py", "backend/**/*.txt", "backend/**/*.toml", "backend/**/*.yaml"]
alwaysApply: false
---

# Backend Development Rules (Python/FastAPI)

## ðŸ Python Standards

### Version & Typing
- Python 3.11+
- Type hints: MANDATORY for all functions, methods, and class attributes
- Use `from __future__ import annotations` for forward references

### Naming Conventions
```python
class UserService:          # PascalCase for classes
    def get_user(self):     # snake_case for functions/methods
        pass

MAX_RETRIES = 3             # UPPERCASE for constants
user_name = "John"          # snake_case for variables
```

### Import Order
```python
# 1. Standard library
import asyncio
from datetime import datetime
from typing import Optional, List

# 2. Third-party
from fastapi import Depends, HTTPException
from sqlalchemy import Column, select
from pydantic import BaseModel, Field

# 3. Local application
from app.models import User
from app.services import AuthService
from app.utils import helper
```

## ðŸ“ Docstrings (MANDATORY!)

Every function/method MUST have a detailed docstring:

```python
async def create_user(
    email: str,
    password: str,
    role: UserRole = UserRole.USER,
) -> User:
    """
    Create a new user in the system.
    
    Performs:
    1. Email validation (uniqueness, format)
    2. Password hashing (bcrypt, 12 rounds)
    3. Database record creation
    4. Welcome email dispatch (async)
    
    Args:
        email: User email. Must be unique in the system.
        password: Plain text password. Minimum 8 characters.
        role: User role. Defaults to USER.
    
    Returns:
        User: Created user object with populated fields.
    
    Raises:
        EmailAlreadyExistsError: If email is already registered.
        WeakPasswordError: If password doesn't meet requirements.
        DatabaseError: On database write error.
    
    Example:
        >>> user = await create_user(
        ...     email="john@example.com",
        ...     password="SecurePass123!"
        ... )
    """
```

## ðŸ—ï¸ Project Structure

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py              # FastAPI app entry point
â”‚   â”œâ”€â”€ settings.py          # Pydantic Settings
â”‚   â”œâ”€â”€ api/                  # API routes
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ deps.py          # Dependencies
â”‚   â”‚   â”œâ”€â”€ auth.py
â”‚   â”‚   â””â”€â”€ v1/
â”‚   â”œâ”€â”€ models/              # SQLAlchemy models
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ base.py
â”‚   â”‚   â””â”€â”€ user.py
â”‚   â”œâ”€â”€ services/            # Business logic
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ auth.py
â”‚   â”œâ”€â”€ schemas/             # Pydantic schemas
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ user.py
â”‚   â””â”€â”€ utils/               # Helpers
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ security.py
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ integration/
â”‚   â””â”€â”€ e2e/
â”œâ”€â”€ alembic/                 # Migrations
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ settings.py              # Alternative: root settings
â””â”€â”€ .env.example
```

## âš™ï¸ Pydantic Settings

Always use Pydantic Settings for configuration:

```python
from pydantic import Field
from pydantic_settings import BaseSettings, SettingsConfigDict

class DatabaseSettings(BaseSettings):
    model_config = SettingsConfigDict(env_prefix="DB_")
    
    host: str = Field(description="Database host")
    port: int = Field(default=5432)
    user: str = Field(description="Database user")
    password: str = Field(description="Database password")
    name: str = Field(description="Database name")
    
    @property
    def url(self) -> str:
        return f"postgresql+asyncpg://{self.user}:{self.password}@{self.host}:{self.port}/{self.name}"

class Settings(BaseSettings):
    model_config = SettingsConfigDict(
        env_file=".env",
        env_file_encoding="utf-8",
        extra="ignore",
    )
    
    db: DatabaseSettings = DatabaseSettings()
    debug: bool = Field(default=False)
    environment: str = Field(default="local")

settings = Settings()
```

## ðŸ§ª Testing Requirements

### Minimum tests per endpoint: 5
```python
class TestUserEndpoint:
    async def test_success(self):
        """âœ… Success scenario (200/201)"""
        
    async def test_unauthorized(self):
        """ðŸ” Without authorization (401)"""
        
    async def test_forbidden(self):
        """ðŸš« No access rights (403)"""
        
    async def test_not_found(self):
        """â“ Resource not found (404)"""
        
    async def test_validation_error(self):
        """âš ï¸ Invalid data (422)"""
```

### Pytest markers
```python
@pytest.mark.unit          # Fast isolated tests
@pytest.mark.integration   # Require DB/Redis
@pytest.mark.slow          # Long tests (> 5 sec)
```

## ðŸš« Prohibited

- Hardcoding secrets in code
- Using `os.getenv()` instead of Pydantic Settings
- Skipping type hints
- Functions without docstrings
- Committing without tests
