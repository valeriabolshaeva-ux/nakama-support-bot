---
description: Правила для работы с backend файлами Telegram Support Bot
globs: backend/**/*.py
alwaysApply: false
---

# Backend Rules: Telegram Support Bot (Python + aiogram)

## Перед началом ОБЯЗАТЕЛЬНО изучи:
1. `docs/product-requirements.md` — ТЗ
2. `docs/database-schema.md` — схема БД
3. `docs/bot-flows.md` — user flows
4. `docs/message-templates.md` — тексты

## Технологии
- Python 3.11+
- aiogram 3.x (async)
- SQLAlchemy 2.0+ (async)
- SQLite (aiosqlite)
- Pydantic 2.x

## Структура проекта

```
backend/app/
├── bot/
│   ├── handlers/      # Message & callback handlers
│   ├── keyboards/     # InlineKeyboardBuilder
│   ├── states/        # FSM StatesGroup
│   ├── middlewares/   # Request middlewares
│   └── filters/       # Custom filters (IsOperator, etc.)
├── database/
│   ├── models.py      # SQLAlchemy models
│   ├── operations.py  # Async CRUD functions
│   └── connection.py  # Engine, session factory
├── services/          # Business logic
├── config/
│   ├── settings.py    # Pydantic Settings
│   ├── texts.py       # Bot message templates
│   └── categories.py  # Ticket categories
├── utils/
└── main.py
```

## Стандарты кода

### Type Hints — ОБЯЗАТЕЛЬНЫ
```python
async def get_user_binding(
    session: AsyncSession,
    tg_user_id: int
) -> UserBinding | None:
    ...
```

### Именование
- `PascalCase` — классы, модели, StatesGroup
- `snake_case` — функции, переменные
- `UPPERCASE` — константы
- Handlers: `handle_<action>` или `on_<action>`
- Callbacks: `callback_<action>`

### Порядок импортов
```python
# 1. Standard library
import asyncio
from datetime import datetime

# 2. Third-party
from aiogram import Router, F
from sqlalchemy.ext.asyncio import AsyncSession

# 3. Local
from app.config.settings import settings
from app.database.operations import get_ticket
```

### Docstrings — ОБЯЗАТЕЛЬНЫ
```python
async def create_ticket(
    session: AsyncSession,
    tg_user_id: int,
    project_id: int,
    category: str,
    description: str
) -> Ticket:
    """
    Create new support ticket.
    
    Args:
        session: Database session
        tg_user_id: Telegram user ID
        project_id: Project ID
        category: Ticket category
        description: Problem description
        
    Returns:
        Created Ticket object
        
    Raises:
        ValueError: If project not found
    """
```

## Handlers

### Router structure
```python
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery
from aiogram.filters import Command

router = Router(name="ticket")

@router.message(Command("start"))
async def handle_start(message: Message) -> None:
    ...

@router.callback_query(F.data.startswith("category:"))
async def callback_category(callback: CallbackQuery) -> None:
    ...
```

### Использование текстов
```python
from app.config.texts import Texts

await message.answer(Texts.WELCOME)
await message.answer(Texts.ticket_created(number=123))
```

## FSM States

```python
from aiogram.fsm.state import State, StatesGroup

class TicketCreation(StatesGroup):
    waiting_category = State()
    waiting_description = State()
    waiting_attachments = State()
```

### Работа с state
```python
@router.callback_query(F.data.startswith("category:"))
async def callback_category(
    callback: CallbackQuery,
    state: FSMContext
) -> None:
    category = callback.data.split(":")[1]
    await state.update_data(category=category)
    await state.set_state(TicketCreation.waiting_description)
    await callback.message.answer(Texts.ASK_DESCRIPTION)
```

## Keyboards

```python
from aiogram.utils.keyboard import InlineKeyboardBuilder
from app.config.categories import CATEGORIES

def get_categories_keyboard() -> InlineKeyboardMarkup:
    builder = InlineKeyboardBuilder()
    for cat in CATEGORIES:
        builder.button(
            text=f"{cat['emoji']} {cat['label']}",
            callback_data=f"category:{cat['id']}"
        )
    builder.adjust(1)
    return builder.as_markup()
```

## Database Operations

```python
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession

async def get_active_ticket(
    session: AsyncSession,
    tg_user_id: int
) -> Ticket | None:
    """Get user's active (non-closed) ticket."""
    stmt = select(Ticket).where(
        Ticket.tg_user_id == tg_user_id,
        Ticket.status != "closed"
    ).order_by(Ticket.created_at.desc())
    
    result = await session.execute(stmt)
    return result.scalar_one_or_none()
```

## Filters

```python
from aiogram.filters import Filter
from aiogram.types import Message

class IsOperator(Filter):
    async def __call__(self, message: Message) -> bool:
        return message.from_user.id in settings.operators
```

## Тестирование

### Структура тестов
```python
# tests/unit/test_ticket_service.py
import pytest
from app.services.ticket import create_ticket

@pytest.mark.asyncio
async def test_create_ticket(db_session):
    """Test ticket creation with required fields."""
    ticket = await create_ticket(
        session=db_session,
        tg_user_id=123456,
        project_id=1,
        category="bug",
        description="Test"
    )
    
    assert ticket.number == 1
    assert ticket.status == "new"
```

### Fixtures
```python
# tests/conftest.py
@pytest.fixture
async def db_session():
    engine = create_async_engine("sqlite+aiosqlite:///:memory:")
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    
    async with async_sessionmaker(engine)() as session:
        yield session
```

## Запрещено

- Синхронный код в async handlers
- Хардкод BOT_TOKEN, CHAT_ID
- Блокирующие операции в event loop
- Тексты напрямую в handlers (только через Texts)
- Пропуск type hints
- Callback data > 64 байт
