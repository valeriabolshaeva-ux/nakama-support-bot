# ==============================================================================
# CURSOR RULES — Telegram Support Bot
# ==============================================================================
# Правила для AI-агентов в Cursor IDE
# Проект: Telegram бот поддержки клиентов
# ==============================================================================

## Обзор проекта

Telegram Support Bot — бот для поддержки клиентов:
- Приём обращений через личные сообщения
- Идентификация клиентов через invite-code
- Создание тикетов с отдельными topics в Support Group
- Управление статусами через inline-кнопки
- Сбор CSAT после закрытия

## Перед началом работы ОБЯЗАТЕЛЬНО:

1. Прочитай `docs/product-requirements.md` — полное ТЗ проекта
2. Прочитай `docs/project-plan.md` — план разработки
3. Прочитай `docs/database-schema.md` — схема БД
4. Прочитай `docs/bot-flows.md` — user flows
5. Прочитай `docs/message-templates.md` — тексты сообщений
6. **Только после этого приступай к выполнению!**

## Язык

- Код, комментарии, docstrings — на **английском**
- Документация и changelog — на **русском**
- Общение с пользователем — на **русском**
- Тексты бота для клиентов — на **русском**

## Секреты и конфигурация

### Золотые правила:
- ✅ Секреты — ТОЛЬКО в .env (никогда не коммитим!)
- ✅ В репозитории — ТОЛЬКО .env.example (с плейсхолдерами)
- ✅ Валидация конфига — через Pydantic Settings
- ❌ НИКОГДА не хардкодить BOT_TOKEN, chat_id и другие секреты
- ❌ AI-агенты НИКОГДА не создают/редактируют .env

## Python / aiogram

### Версия и типизация:
- Python 3.11+
- aiogram 3.x (async/await)
- Type hints: ОБЯЗАТЕЛЬНЫ для всех функций

### Именование:
- `PascalCase` — классы, модели
- `snake_case` — функции, переменные, handlers
- `UPPERCASE` — константы
- Handlers: `handle_<action>` или `on_<action>`
- Callbacks: `callback_<action>`

### Порядок импортов:
1. Standard library (asyncio, datetime, etc.)
2. Third-party (aiogram, sqlalchemy, pydantic)
3. Local application (app.*)

### Docstrings (ОБЯЗАТЕЛЬНО!):
```python
async def handle_start(message: Message, state: FSMContext) -> None:
    """
    Handle /start command with optional invite code.
    
    Args:
        message: Incoming message from user
        state: FSM context for conversation state
        
    Flow:
        1. Extract invite code from deep link if present
        2. Validate code and bind user to project
        3. Show welcome message or triage flow
    """
```

### Структура handlers:
```python
# === IMPORTS ===
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery

# === ROUTER ===
router = Router(name="start")

# === HANDLERS ===
@router.message(Command("start"))
async def handle_start(message: Message) -> None:
    ...

# === CALLBACKS ===
@router.callback_query(F.data.startswith("category:"))
async def callback_category(callback: CallbackQuery) -> None:
    ...
```

## База данных (SQLite + SQLAlchemy)

### Модели:
- Использовать SQLAlchemy 2.0 declarative style
- Все таблицы наследуются от Base
- Обязательные поля: id, created_at

### Операции:
- Async sessions через `async_sessionmaker`
- Отдельный файл `operations.py` с CRUD функциями
- Транзакции через `async with session.begin()`

## Keyboards (Inline)

### Структура:
```python
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.utils.keyboard import InlineKeyboardBuilder

def get_categories_keyboard() -> InlineKeyboardMarkup:
    """Build categories selection keyboard."""
    builder = InlineKeyboardBuilder()
    for cat in CATEGORIES:
        builder.button(
            text=cat.label,
            callback_data=f"category:{cat.id}"
        )
    builder.adjust(1)  # One button per row
    return builder.as_markup()
```

### Callback data:
- Формат: `action:value` или `action:id:extra`
- Максимум 64 байта!
- Использовать CallbackData factory для сложных случаев

## FSM (Finite State Machine)

### States:
```python
from aiogram.fsm.state import State, StatesGroup

class TicketCreation(StatesGroup):
    waiting_category = State()
    waiting_description = State()
    waiting_attachments = State()
```

### Использование:
- Сохранять данные в `state.update_data()`
- Очищать state после завершения flow: `state.clear()`

## Тексты сообщений

### Правила:
- Все тексты — в `config/texts.py`
- Никаких хардкод строк в handlers
- Использовать f-strings с переменными
- Тональность: дружелюбная, короткие фразы

### Пример:
```python
# config/texts.py
class Texts:
    WELCOME = "Привет! Я бот поддержки. Выберите, что случилось."
    TICKET_CREATED = "Готово, обращение #{number} принято!"
    ASK_DESCRIPTION = "Опишите проблему подробнее."
```

## Тестирование

### Требования:
- Каждый handler = минимум 3 теста
- Моки для Telegram API
- Тесты БД с in-memory SQLite

### Структура тестов:
```python
@pytest.mark.asyncio
async def test_start_with_valid_code():
    """Test /start command with valid invite code."""
    ...

@pytest.mark.asyncio  
async def test_start_without_code():
    """Test /start command triggers triage flow."""
    ...
```

## Git

### Формат коммитов (Conventional Commits):
- `feat(bot)` — новый handler/функция
- `fix(db)` — исправление бага
- `refactor(keyboards)` — рефакторинг
- `test(handlers)` — тесты
- `docs` — документация

### Примеры:
```
feat(bot): add ticket creation flow with category selection
fix(db): correct user binding when project changes
test(handlers): add tests for CSAT feedback collection
```

## Структура проекта

```
backend/
├── app/
│   ├── bot/
│   │   ├── handlers/         # Message handlers
│   │   │   ├── __init__.py
│   │   │   ├── start.py      # /start, invite-code
│   │   │   ├── ticket.py     # Ticket creation flow
│   │   │   ├── operator.py   # Operator actions in group
│   │   │   └── common.py     # Help, project switch
│   │   ├── keyboards/        # Inline keyboards
│   │   │   ├── __init__.py
│   │   │   ├── categories.py
│   │   │   ├── ticket.py
│   │   │   └── operator.py
│   │   ├── middlewares/      # Request middlewares
│   │   ├── states/           # FSM states
│   │   └── filters/          # Custom filters
│   ├── database/
│   │   ├── models.py         # SQLAlchemy models
│   │   ├── operations.py     # CRUD functions
│   │   └── connection.py     # DB connection
│   ├── services/             # Business logic
│   │   ├── ticket.py         # Ticket service
│   │   └── notification.py   # Sending to group
│   ├── config/
│   │   ├── settings.py       # Pydantic Settings
│   │   ├── texts.py          # Message templates
│   │   └── categories.py     # Categories config
│   ├── utils/
│   │   ├── timezone.py       # Working hours check
│   │   └── formatting.py     # Message formatting
│   └── main.py               # Entry point
├── tests/
└── requirements.txt
```

## Changelog агента

После выполнения задачи создай файл `docs/changelogs/YYYY-MM-DD-description.md`:
- Что сделал
- Какие файлы создал/изменил
- Как проверить работу
- Известные ограничения

## Запрещено

- Хардкодить BOT_TOKEN, CHAT_ID и любые секреты
- Редактировать .env файлы
- Использовать синхронный код в async handlers
- Блокирующие операции в event loop
- Пропускать type hints
- Коммитить без осмысленного сообщения
